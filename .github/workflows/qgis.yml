name: 🍏 Build QGIS
on:
  workflow_dispatch:
  push:
    paths:
    - 'config/**'
    - 'qgis_build/**'
    - '.github/workflows/qgis.yml'

env:
  CI_RELEASE: nightly
  CCACHE_DIR: ${{ github.workspace }}/ccache
  PACKAGER_DIR: ${{ github.workspace }}/packager
  QGIS_SOURCE_DIR: ${{ github.workspace }}/QGIS
  QGIS_BUILD_DIR: ${{ github.workspace }}/build


jobs:
  mac_os_build:
    if: github.repository == 'qgis/QGIS-Mac-Packager'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          path: ${{ env.PACKAGER_DIR }}

      - name: Set environment
        run: |
          source ${PACKAGER_DIR}/config/${CI_RELEASE}.conf
          QGIS_DEPS_VERSION=$(echo ${QGIS_DEPS_SDK_VERSION} | sed -r 's/([0-9]+\.[0-9]+)\.[0-9]+$/\1/')
          QGIS_DEPS_PATH=/opt/QGIS/qgis-deps-${QGIS_DEPS_VERSION}
          echo "QGIS_DEPS_VERSION=${QGIS_DEPS_VERSION}" >> $GITHUB_ENV
          echo "QGIS_DEPS_SDK_VERSION=${QGIS_DEPS_SDK_VERSION}" >> $GITHUB_ENV
          echo "QGIS_DEPS_PATH=${QGIS_DEPS_PATH}" >> $GITHUB_ENV
          sudo mkdir -p ${QGIS_DEPS_PATH}

      - name: Download qgis-deps
        run: |
          wget -q https://github.com/qgis/QGIS-Mac-Packager/releases/download/qgis-deps-${QGIS_DEPS_SDK_VERSION}/qgis-deps-${QGIS_DEPS_SDK_VERSION}.tar.gz.partaa
          wget -q https://github.com/qgis/QGIS-Mac-Packager/releases/download/qgis-deps-${QGIS_DEPS_SDK_VERSION}/qgis-deps-${QGIS_DEPS_SDK_VERSION}.tar.gz.partab
          wget -q https://github.com/qgis/QGIS-Mac-Packager/releases/download/qgis-deps-${QGIS_DEPS_SDK_VERSION}/qgis-deps-${QGIS_DEPS_SDK_VERSION}.tar.gz.partac
          cd ${QGIS_DEPS_PATH}
          cat ${GITHUB_WORKSPACE}/qgis-deps-${QGIS_DEPS_SDK_VERSION}.tar.gz.part* | sudo tar xzf -
          ls
          source ${QGIS_DEPS_PATH}/deps-${QGIS_DEPS_VERSION}.conf
          echo "VERSION_QT=${VERSION_QT}" >> $GITHUB_ENV

      - name: fetch QGIS
        uses: actions/checkout@v2
        with:
          repository: qgis/QGIS
          path: ${{ env.QGIS_SOURCE_DIR }}

      - name: Prepare build cache for branch/tag
        uses: pat-s/always-upload-cache@v2.1.5
        with:
          path: ${{ env.CCACHE_DIR }}
          # The branch or tag ref that triggered the workflow run. For branches this in the format refs/heads/<branch_name>, and for tags it is refs/tags/<tag_name>
          key: build-mac-ccache-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            build-mac-ccache-${{ github.ref }}-
            build-mac-ccache-refs/heads/master-

      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          dir: ${{ github.workspace }}
          cached: ${{ steps.cache-qt.outputs.cache-hit }}
          version: '5.15.2'
          host: 'mac'
          target: 'desktop'

      - name: move Qt to /opt
        run: |
          sudo mv ${{ github.workspace }}/Qt /opt

      - name: Install ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          brew install ccache
          ccache --set-config=max_size=2.0G
          ccache -s

      - name: Run pkg
        run: |
          mkdir ${QGIS_BUILD_DIR}
          
          MAJOR=$(sed -ne 's/[sS][eE][tT](CPACK_PACKAGE_VERSION_MAJOR "\([0-9]*\)")/\1/p' ${QGIS_SOURCE_DIR}/CMakeLists.txt)
          MINOR=$(sed -ne 's/[sS][eE][tT](CPACK_PACKAGE_VERSION_MINOR "\([0-9]*\)")/\1/p' ${QGIS_SOURCE_DIR}/CMakeLists.txt)
          PATCH=$(sed -ne 's/[sS][eE][tT](CPACK_PACKAGE_VERSION_PATCH "\([0-9]*\)")/\1/p' ${QGIS_SOURCE_DIR}/CMakeLists.txt)
          echo "Building QGIS ${CI_RELEASE} version ${MAJOR}.${MINOR}.${PATCH}"
          
          cd ${PACKAGER_DIR}
          ./qgis-mac-packager.bash ${CI_RELEASE} ${MAJOR}.${MINOR}.${PATCH} ${CI_RELEASE}.dmg

